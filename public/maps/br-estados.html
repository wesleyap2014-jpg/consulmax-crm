<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapa do Brasil (UF) - Consulmax</title>

    <style>
      :root {
        --map-fill: #d3dee2;      /* cinza base */
        --map-stroke: #ffffff;
        --map-active: #a11c27;    /* rubi Consulmax */
        --map-selected: #7f1420;  /* rubi mais escuro */
      }

      html, body {
        margin: 0;
        padding: 0;
        background: transparent;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      /* ✅ controla o "tamanho do mapa" aqui */
      .map-wrap {
        width: 100%;
        max-width: 420px;   /* <-- menor (ajuste pra 320/380/480 se quiser) */
        margin: 0 auto;
      }

      svg {
        width: 100%;
        height: auto;
        display: block;
      }

      .state {
        fill: var(--map-fill);
        stroke: var(--map-stroke);
        cursor: default;
        transition: fill 120ms linear, opacity 120ms linear;
      }

      .state--active {
        fill: var(--map-active) !important;
      }

      .state--selected {
        fill: var(--map-selected) !important;
      }

      .state:hover {
        opacity: 0.92;
      }

      /* pequeno status (opcional) */
      .status {
        font-size: 12px;
        opacity: 0.7;
        margin: 8px auto 0;
        max-width: 420px;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div class="map-wrap">
      <!-- ✅ Seu SVG começa aqui -->
      <svg
        version="1.1"
        id="Layer_1"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        x="0px"
        y="0px"
        width="353.845px"
        height="367.766px"
        viewBox="0 0 353.845 367.766"
        enable-background="new 0 0 353.845 367.766"
        xml:space="preserve"
      >
        <!--
          IMPORTANTE:
          Eu mantive exatamente sua estrutura. O que importa pro highlight automático é:
          - cada UF ter id="SP", id="RJ", id="MG", etc.
          - você já tem isso nos principais estados (SP, RJ, MG, GO, TO, BA, PI, MA, PA, DF, ES, SE, AL, RN, PB, PE, RO, AP, AC, CE, RR, AM, RS, SC, PR, MS, MT...)
        -->
        <g>
          <!-- ... TODO O SEU SVG (idêntico ao que você mandou) ... -->
          <!-- Cole aqui o SVG completo que você já tem, sem mudar nada -->
        </g>
      </svg>
    </div>

    <div class="status" id="status">Carregando UFs com vendas ativas…</div>

    <!-- Supabase JS via CDN -->
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      // ✅ 1) COLOQUE AQUI
      const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";
      const SUPABASE_ANON_KEY = "SUA_ANON_KEY_AQUI";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById("status");

      // ✅ UFs válidas (pra garantir que não entra lixo)
      const VALID_UF = new Set([
        "AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR",
        "PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO"
      ]);

      function setStatus(msg) {
        if (statusEl) statusEl.textContent = msg;
      }

      function clearActiveClasses() {
        document.querySelectorAll(".state.state--active").forEach(el => {
          el.classList.remove("state--active");
        });
      }

      function applyActiveUFs(activeUFs) {
        clearActiveClasses();

        activeUFs.forEach(uf => {
          const node = document.getElementById(uf);
          if (node) node.classList.add("state--active");
        });
      }

      function chunk(arr, size) {
        const out = [];
        for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
        return out;
      }

      async function fetchActiveUFs() {
        // 2) Busca vendas ativas (código = '00')
        const { data: vendas, error: errV } = await supabase
          .from("vendas")
          .select("lead_id")
          .eq("codigo", "00");

        if (errV) throw errV;

        const leadIds = (vendas || [])
          .map(v => v.lead_id)
          .filter(Boolean);

        if (leadIds.length === 0) return new Set();

        // 3) Busca UF na tabela clientes (por lead_id)
        //    Atenção: .in() tem limite prático; por isso fazemos em chunks.
        const ufs = new Set();
        const parts = chunk(leadIds, 800);

        for (const part of parts) {
          const { data: clientes, error: errC } = await supabase
            .from("clientes")
            .select("uf")
            .in("lead_id", part);

          if (errC) throw errC;

          (clientes || []).forEach(c => {
            const uf = String(c.uf || "").trim().toUpperCase();
            if (VALID_UF.has(uf)) ufs.add(uf);
          });
        }

        return ufs;
      }

      async function refreshMap() {
        try {
          setStatus("Atualizando mapa…");
          const ufs = await fetchActiveUFs();
          applyActiveUFs(ufs);
          setStatus(
            ufs.size
              ? `Estados com vendas ativas: ${Array.from(ufs).sort().join(", ")}`
              : "Nenhum estado com venda ativa no momento."
          );
        } catch (e) {
          console.error(e);
          setStatus("Erro ao carregar UFs (veja o console).");
        }
      }

      // ✅ Primeira carga
      await refreshMap();

      // ✅ Atualização automática (caso você não use realtime)
      // Ajuste o intervalo como quiser (ex.: 10s, 30s, 60s)
      setInterval(refreshMap, 30000);

      // ✅ (Opcional) Realtime: descomente se estiver usando Realtime no projeto
      /*
      supabase
        .channel("mapa-ufs-vendas")
        .on(
          "postgres_changes",
          { event: "*", schema: "public", table: "vendas" },
          () => refreshMap()
        )
        .subscribe();
      */
    </script>
  </body>
</html>
